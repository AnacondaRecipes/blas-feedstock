{% set version = "3.8.0" %}
{% set build_num = "0" %}
{% set version_major = version.split(".")[0] %}
{% set blas_major = "2" %}

# blas_major denotes major infrastructural change to how blas is managed
package:
  name: blas-split
  version: "{{ blas_major }}.{{ build_num }}"

requirements:
  host:
    - openblas 0.3.3   # [blas_impl == 'openblas']
    - mkl 2019.1       # [blas_impl == 'mkl']
    - blis 0.5.0       # [blas_impl == 'blis']

outputs:
  - name: libblas
    build:
      string: "{{ build_num }}_{{ blas_impl }}"
      run_exports:
        - {{ pin_subpackage("libblas", max_pin="x") }}
      track_features:
       - blas_{{ blas_impl }}     # [blas_impl != blas_default_impl]
    requirements:
      host:
        - openblas 0.3.3   # [blas_impl == 'openblas']
        - mkl 2019.1       # [blas_impl == 'mkl']
        - blis 0.5.0       # [blas_impl == 'blis']
      run:
        - openblas 0.3.3   # [blas_impl == 'openblas']
        - mkl 2019.1       # [blas_impl == 'mkl']
        - blis 0.5.0       # [blas_impl == 'blis']
      run_constrained:
        - {{ pin_subpackage("libcblas", exact=True) }}
        - {{ pin_subpackage("liblapack", exact=True) }}    # [blas_impl != 'blis']
        - {{ pin_subpackage("liblapacke", exact=True) }}   # [blas_impl != 'blis']
    files:
      - lib/libblas.so.{{ version_major }}      # [linux]
      - lib/libblas.{{ version_major }}.dylib   # [osx]

  - name: libcblas
    build:
      string: "{{ build_num }}_{{ blas_impl }}"
      run_exports:
        - {{ pin_subpackage("libcblas", max_pin="x") }}
      track_features:
       - blas_{{ blas_impl }}     # [blas_impl != 'openblas']
    requirements:
      host:
        - {{ pin_subpackage("libblas", exact=True) }}
      run:
        - {{ pin_subpackage("libblas", exact=True) }}
      run_constrained:
        - {{ pin_subpackage("liblapack", exact=True) }}    # [blas_impl != 'blis']
        - {{ pin_subpackage("liblapacke", exact=True) }}   # [blas_impl != 'blis']
    files:
      - lib/libcblas.so.{{ version_major }}      # [linux]
      - lib/libcblas.{{ version_major }}.dylib   # [osx]

  {% if blas_impl != 'blis' %}
  - name: liblapack
    build:
      string: "{{ build_num }}_{{ blas_impl }}"
      run_exports:
        - {{ pin_subpackage("liblapack", max_pin="x.x") }}
      track_features:
       - blas_{{ blas_impl }}     # [blas_impl != 'openblas']
    requirements:
      host:
        - {{ pin_subpackage("libblas", exact=True) }}
      run:
        - {{ pin_subpackage("libblas", exact=True) }}
      run_constrained:
        - {{ pin_subpackage("libcblas", exact=True) }}
        - {{ pin_subpackage("liblapacke", exact=True) }}
    files:
      - lib/liblapack.so.{{ version_major }}      # [linux]
      - lib/liblapack.{{ version_major }}.dylib   # [osx]

  - name: liblapacke
    build:
      string: "{{ build_num }}_{{ blas_impl }}"
      run_exports:
        - {{ pin_subpackage("liblapacke", max_pin="x.x") }}
      track_features:
       - blas_{{ blas_impl }}     # [blas_impl != 'openblas']
    requirements:
      - {{ pin_subpackage("libblas", exact=True) }}
      - {{ pin_subpackage("libcblas", exact=True) }}
      - {{ pin_subpackage("liblapack", exact=True) }}
    files:
      - lib/liblapacke.so.{{ version_major }}      # [linux]
      - lib/liblapacke.{{ version_major }}.dylib   # [osx]
  {% endif %}

  # For compatiblity
  - name: blas
    version: "{{ blas_major }}.{{ build_num }}"
    build:
      string: "{{ blas_impl }}"
    requirements:
      run:
        - {{ pin_subpackage("liblapack", exact=True) }}      # [blas_impl != 'blis']
        - {{ pin_subpackage("liblapacke", exact=True) }}     # [blas_impl != 'blis']
        - liblapack  {{ version }} *netlib                   # [blas_impl == 'blis']
        - liblapacke {{ version }} *netlib                   # [blas_impl == 'blis']
        - {{ pin_subpackage("libcblas", exact=True) }}
        - {{ pin_subpackage("libblas", exact=True) }}

about:
  home: https://github.com/conda-forge/blas-feedstock
  license: BSD 3-clause
  summary: Metapackage to select the BLAS variant. Use conda's pinning mechanism in your environment to control which variant you want.

extra:
  recipe-maintainers:
    - jakirkham
    - pelson
    - isuruf
